---
# SPDX-License-Identifier: Apache-2.0
# Copyright 2024 The Linux Foundation <matthew.watkins@linuxfoundation.org>

name: "Nexus Upload"
description: "Nexus Upload Action"

inputs:
  NEXUS_USERNAME:
    description: "Nexus username"
    required: true
  NEXUS_PASSWORD:
    description: "Nexus password"
    required: true
  NEXUS_SERVER:
    description: "Nexus server"
    required: true
  NEXUS_REPOSITORY:
    description: "Nexus repository"
    required: true
  UPLOAD_DIRECTORY:
    description: "Directory containing files to upload"
    required: true
  FILENAME_SUFFIX:
    description: "File extension to match"
    required: false

  #Â Not implemented yet; repository_format may be superfluous
  # We might need it in future, so leaving a reminder here
  # repository_format:
  #   description: "Nexus repository format"
  #   required: false

outputs:
  ERRORS:
    description: "Occurence of errors [true|false]"
    value: ${{ steps.nexus-upload.outputs.errors }}
  SUCCESSES:
    description: "Number of successful uploads"
    value: ${{ steps.nexus-upload.outputs.successes }}
  FAILURES:
    description: "Number of failed uploads"
    value: ${{ steps.nexus-upload.outputs.failures }}

runs:
  using: "composite"
  steps:
    - name: "Set GitHub Action path"
      run: |
        # Write GITHUB_ACTION_PATH to GITHUB_PATH
        echo "$GITHUB_ACTION_PATH" >> "$GITHUB_PATH"
      shell: bash
      env:
        GITHUB_ACTION_PATH: ${{ github.action_path }}

    - name: "Writing cURL configuration file"
      shell: bash
      # yamllint disable-line rule:line-length
      run: |
        # Writing cURL configuration file
        echo "machine ${{ inputs.NEXUS_SERVER }} > .netrc
        echo "  login ${{ inputs.NEXUS_USERNAME }} >> .netrc
        echo "  password ${{ inputs.NEXUS_PASSWORD }}" >> .netrc
        echo "machine ${{ inputs.NEXUS_SERVER }} login ${{ inputs.NEXUS_USERNAME }} password ***"

    - name: "Uploading files to Nexus"
      id: nexus-upload
      shell: bash
      run: |
        # Uploading files to Nexus server
        if [ -z ${{ inputs.FILENAME_SUFFIX }} ]; then
          nexus-upload.sh -r ${{ inputs.NEXUS_REPOSITORY }} -d ${{ inputs.UPLOAD_DIRECTORY }}
        else
          # Matching files by file extension is an optional argument
          nexus-upload.sh -r ${{ inputs.NEXUS_REPOSITORY }} \
            -d ${{ inputs.UPLOAD_DIRECTORY }} -e ${{ inputs.FILENAME_SUFFIX }}
        fi

    - name: "Removing cURL configuration file"
      shell: bash
      run: |
        # Removing cURL configuration file
        rm .netrc
